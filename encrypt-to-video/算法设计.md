视频提供了下列我们需要用到的元数据（metadata）：

+ 帧率（fps）：每一秒显示多少张图片
+ 视频的总时长（total duration）
+ 分辨率（resolution）：描述了每一帧的图片中有多少个像素点

视频的 RGB 颜色格式有 3 个颜色通道，每个通道的值介于 `0 ~ 255` 之间，即 1 字节的无符号整数。

而每个通道的值变化很小的话，肉眼看不出变化或者颜色的变化很小：

![](../images/2024/1735034730429-54251664-a6c2-47f2-b305-e157f4ea9b32.png)

为了让变化的值尽可能地小，我们选择只修改每个通道的最低一位，这样的话，每个颜色通道要么只增加一，要么只减少 1.

## 加密算法
描述：将颜色通道的值与上 `11111110` （当要加密的 bit 为 0 的时候）或者或上 `00000001`（当要加密的 bit 为 1 的时候）

这样可以保证只修改颜色通道的最低位的同时，使其最低位永远为被加密的 bit。

举个例子，如果我们要加密的一个字节的二进制表示为 `10101110`,则我们需要 3 个像素的 8 个通道，剩余的一个通道用于加密另一个字节。

假设这 8 个通道的值分别为 `[32,12,13,212,21,53,32,21]`，则加密的过程如下：

+ 加密 `1`：32 变为 `32 | 00000001`
+ 加密 `0`：12 变为 `12 & 11111110`
+ ......

从上述算法可以知道，只要知道了需要加密的数据的二进制表示，就可以将其加密到视频中。

所以，我们不在乎需要加密的数据是一个视频还是一个其它的东西。

所以，我们读取一个要被加密文件的时候，直接读取它的字节流就可以了。而不在乎它使用什么格式编码之类的。

## 算法的可行性分析
如果需要加密一个 100 MB 的文件,则需要加密的 bit 有 `100 x 1024KB x 1024B x 8bit = 838,860,800 bit`,则如果给定一个分辨率为 `1920 x 1080`，`fps = 25` 的视频，下面计算这个视频至少需要多长的时间才能够完整地加密：

+ 每一秒可以有 `1920 x 1080 x 25 x 3 = 155,520,000` 个颜色通道用于加密
+ 则加密 `838,860,800` 个 bit 需要 `838,860,800 / 155,520,000 约等于 5.3939094650 ` 秒就能够加密。

从中可以看出，加密 100 MB 的数据只需要 1080p 的视频约 6 秒的时间（在 fps 为 25 的时候），效率是很高的。

## 解密算法
对于一个素材视频，不太可以刚好将其所有的颜色通道都用于加密，所以，需要知道哪些颜色通道包含了加密的数据，哪些没有。

为此，我们在视频刚开始的颜色通道中存储 2 条数据：

+ 5 字节的字符串 `"video"`，此数据用来标识输出的包含加密数据的视频是否是通过此算法生成的
+ 4 字节（32 bit）的长度值，这个长度值以字节为单位。所以，最大的加密数据的大小为 ![image](../images/2025/f4ef90e96fadfd6ea357aae93450c9b3.svg)约等于 4096MB ，注意，这个长度不包含这 37 个字节本身

通过长度我们就可以计算出有多少个通道被用于加密。

然后，直接将所有被用于加密的通道的最后一位读取出来，按照顺序读取就可以还原出原来的文件。

## 加速加密过程
常用的加速手段就是多线程。

下面我们来确定如何使用多线程来处理不同的部分。

假设我们有 `N_THREADS` 个线程可供使用，被加密的文件的大小为 a 字节。则每个线程需要处理 `a / N_THREADS` 字节。

为了处理没有除尽这种情况，我们让最后一个线程处理全部剩下的字节。

为了不让每个线程重复处理同一部分，我们需要确定传递给线程的参数：

+ 从被加密文件 `fileToEncrypted` 的 `offsetToEncrypted` 处开始读取 `lengthToEncrypted`字节要被加密的数据
+ 从素材视频 `video` 的第 `frame` 帧的第 `row` 行的第 `col` 列个像素点的第 `channel` 个通道开始执行加密算法

由于被加密的数据最多只有 4096MB，对于现代计算机而言，不算多，所以，可以不考虑加密的文件过大而导致内存不够用的情况。

## 加速解密的过程
还是使用多线程。

与加密的过程不同，解密的过程包含一个创建文件的过程，而在多个线程同时解密的过程中，这个文件是不完整的，要等所有线程都解密完成之后，才能“拼接”出原来的文件。并且，多个线程生成的不同文件部分具有顺序的限制。

多个线程生成的部分文件本质上还是一个字节数组，所以，如果线程支持返回一个指针，可以返回该字节数组的指针。同时，为了标识这个字节数组与其它字节数组的顺序，需要将它的编号（下面会介绍）也一同返回。

为了能够同时处理一个视频的不同帧的不同颜色通道，需要定义以下线程的参数：

+ 从视频 `video` 的 `frame` 帧的第 `row` 行第 `col` 列的第 `channel` 个通道开始读取 `length`个被加密的通道。并且，当前处理后字节数组的编号是 `number`。

 

